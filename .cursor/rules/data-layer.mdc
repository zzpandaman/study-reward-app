---
description: "æ•°æ®å±‚è§„èŒƒå’Œå­˜å‚¨é€‚é…å™¨ä½¿ç”¨è§„åˆ™"
globs:
  - "src/data/**/*.ts"
alwaysApply: false
---

# æ•°æ®å±‚å¼€å‘è§„èŒƒ

## å­˜å‚¨é€‚é…å™¨

### æ¥å£å®ç°

æ‰€æœ‰å­˜å‚¨é€‚é…å™¨å¿…é¡»å®ç° `IStorageAdapter` æ¥å£ï¼š

```typescript
interface IStorageAdapter {
  read(): AppData | null;
  write(data: AppData): void;
  exists(): boolean;
  backup(): void;
  restore(): AppData | null;
}
```

### å½“å‰å®ç°

- âœ… `LocalStorageAdapter`ï¼šlocalStorageå®ç°
- ğŸ”„ æœªæ¥ï¼š`MySQLStorageAdapter`ï¼šMySQLå®ç°

### ä½¿ç”¨æ–¹å¼

```typescript
// é€šè¿‡å·¥å‚è·å–é€‚é…å™¨
import { StorageAdapterFactory } from './storage-adapter';

const adapter = StorageAdapterFactory.getAdapter();
const data = adapter.read();
```

## æ•°æ®ç®¡ç†å™¨

### æ ¸å¿ƒåŠŸèƒ½

1. **ç‰ˆæœ¬ç®¡ç†**ï¼šè‡ªåŠ¨æ£€æµ‹å’Œå¤„ç†æ•°æ®ç‰ˆæœ¬
2. **æ•°æ®è¿ç§»**ï¼šä»æ—§ç‰ˆæœ¬æ ¼å¼è¿ç§»åˆ°æ–°æ ¼å¼
3. **æ•°æ®éªŒè¯**ï¼šç¡®ä¿æ•°æ®å®Œæ•´æ€§

### ä½¿ç”¨è§„åˆ™

```typescript
// âœ… æ­£ç¡®ï¼šé€šè¿‡dataManageræ“ä½œæ•°æ®
import { dataManager } from '../data/data-manager';

const appData = dataManager.getAppData();
dataManager.saveAppData(appData);

// âŒ é”™è¯¯ï¼šç›´æ¥æ“ä½œlocalStorage
localStorage.setItem('key', JSON.stringify(data));
```

### æ•°æ®è¿ç§»

- âœ… è¿ç§»é€»è¾‘å¿…é¡»åœ¨ `data-manager.ts` ä¸­å®ç°
- âœ… æ”¯æŒä»æ—§ç‰ˆæœ¬è‡ªåŠ¨è¿ç§»
- âœ… è¿ç§»å‰è‡ªåŠ¨å¤‡ä»½
- âœ… è¿ç§»åä¿ç•™åŸæ•°æ®ï¼ˆå¯é€‰æ¸…ç†ï¼‰

### ç‰ˆæœ¬å·ç®¡ç†

```typescript
const CURRENT_SCHEMA_VERSION = 2;  // æ•°æ®ç»“æ„ç‰ˆæœ¬
const CURRENT_VERSION = '1.1.0';   // åº”ç”¨ç‰ˆæœ¬
```

**è§„åˆ™ï¼š**
- ä¿®æ”¹æ•°æ®ç»“æ„æ—¶ï¼Œæ›´æ–° `CURRENT_SCHEMA_VERSION`
- å‘å¸ƒæ–°ç‰ˆæœ¬æ—¶ï¼Œæ›´æ–° `CURRENT_VERSION`

## æ•°æ®éªŒè¯

### éªŒè¯è§„åˆ™

1. **å¿…éœ€å­—æ®µæ£€æŸ¥**ï¼šç¡®ä¿æ‰€æœ‰å¿…éœ€å­—æ®µå­˜åœ¨
2. **æ•°æ®ç±»å‹æ£€æŸ¥**ï¼šéªŒè¯æ•°ç»„ã€å¯¹è±¡ç­‰ç±»å‹
3. **æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥**ï¼šéªŒè¯å…³è”æ•°æ®çš„ä¸€è‡´æ€§

### éªŒè¯å®ç°

```typescript
// åœ¨dataManagerä¸­å®ç°éªŒè¯
private validateData(data: AppData): void {
  if (!data.version) {
    throw new Error('Data version is required');
  }
  // ... å…¶ä»–éªŒè¯
}
```

## è€ç”¨æˆ·æ•°æ®è¿ç§»

### æ”¯æŒçš„æ—§ç‰ˆæœ¬é”®

- `study_reward_user_data`
- `study_reward_task_executions`
- `study_reward_products`
- `study_reward_tasks`

### è¿ç§»æµç¨‹

```
1. æ£€æµ‹æ–°æ ¼å¼æ•°æ®
   â†“ (ä¸å­˜åœ¨)
2. æ£€æµ‹æ—§ç‰ˆæœ¬æ•°æ®
   â†“ (å­˜åœ¨)
3. æ‰§è¡Œæ•°æ®è¿ç§»
   â†“
4. ä¿å­˜æ–°æ ¼å¼æ•°æ®
   â†“
5. å®Œæˆï¼ˆä¿ç•™æ—§æ•°æ®ï¼‰
```

### è¿ç§»ä¿è¯

- âœ… è‡ªåŠ¨æ£€æµ‹å’Œè¿ç§»
- âœ… è¿ç§»å‰è‡ªåŠ¨å¤‡ä»½
- âœ… è¿ç§»å¤±è´¥æ—¶ä¿ç•™åŸæ•°æ®
- âœ… æ”¯æŒæ‰‹åŠ¨æ¢å¤

## æ•°æ®å¯¼å‡º/å¯¼å…¥

### å¯¼å‡ºæ ¼å¼

```json
{
  "version": "1.1.0",
  "exportTime": 1234567890,
  "data": {
    "version": {...},
    "userData": {...},
    "taskTemplates": [...],
    "products": [...],
    "taskExecutions": [...]
  }
}
```

### å¯¼å…¥éªŒè¯

- éªŒè¯JSONæ ¼å¼
- éªŒè¯æ•°æ®ç»“æ„
- æ‰§è¡Œæ•°æ®è¿ç§»ï¼ˆå¦‚æœéœ€è¦ï¼‰

## å‚è€ƒæ–‡æ¡£

- @docs/DATA_LAYER.md - æ•°æ®å±‚è¯¦ç»†æ–‡æ¡£
