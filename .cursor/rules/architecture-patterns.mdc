---
description: "三层架构规范和代码组织规则"
globs:
  - "src/**/*.ts"
  - "src/**/*.tsx"
alwaysApply: true
---

# 三层架构规范

本项目采用三层架构设计，严格遵循分层原则。

## 架构层次

### 1. 数据层 (Data Layer)

**位置：** `src/data/`

**职责：**
- 数据存储抽象（适配器模式）
- 数据版本管理和迁移
- 数据验证

**规则：**
- ✅ 数据层**只能**调用数据存储适配器，不能调用API层或视图层
- ✅ 所有数据操作通过 `dataManager` 进行
- ✅ 数据迁移逻辑必须在 `data-manager.ts` 中实现
- ✅ 存储适配器必须实现 `IStorageAdapter` 接口

**示例：**
```typescript
// ✅ 正确：数据层直接调用数据管理器
import { dataManager } from '../data/data-manager';
const appData = dataManager.getAppData();

// ❌ 错误：数据层调用API层
import { TaskTemplateAPI } from '../api/task-api';
```

### 2. 接口能力层 (API Layer)

**位置：** `src/api/`

**职责：**
- RESTful API抽象
- 业务逻辑处理
- 数据验证

**规则：**
- ✅ API类**必须**通过 `ApiClientFactory.getClient()` 调用客户端
- ✅ 所有API方法必须是 `async`，返回 `Promise<ApiResponse<T>>`
- ✅ API类不能直接调用数据层，必须通过客户端
- ✅ 请求/响应类型必须在 `api/types.ts` 中定义

**示例：**
```typescript
// ✅ 正确：API类通过客户端调用
import ApiClientFactory from './client';

export class TaskTemplateAPI {
  static async getTaskTemplates(): Promise<ApiResponse<GetTaskTemplatesResponse>> {
    const client = ApiClientFactory.getClient();
    return client.get<GetTaskTemplatesResponse>('/api/task-templates');
  }
}

// ❌ 错误：API类直接调用数据层
import { dataManager } from '../data/data-manager';
const appData = dataManager.getAppData();
```

### 3. 视图渲染层 (View Layer)

**位置：** `src/components/`

**职责：**
- 用户界面渲染
- 用户交互处理

**规则：**
- ✅ 视图层**只能**通过 `storage.ts` 兼容层或直接调用API层
- ✅ 视图层不能直接调用数据层
- ✅ 所有数据获取通过API层进行

**示例：**
```typescript
// ✅ 正确：通过storage.ts兼容层
import { taskTemplateStorage } from '../utils/storage';
const templates = taskTemplateStorage.get();

// ✅ 正确：直接调用API层
import { TaskTemplateAPI } from '../api';
const response = await TaskTemplateAPI.getTaskTemplates();

// ❌ 错误：直接调用数据层
import { dataManager } from '../data/data-manager';
```

## 依赖规则

### 禁止循环依赖

- 数据层 → ❌ 不能依赖API层或视图层
- API层 → ❌ 不能依赖视图层，✅ 可以依赖数据层（通过LocalService）
- 视图层 → ❌ 不能依赖数据层（通过兼容层或API层间接访问）

### 导入规则

```typescript
// 数据层
import { dataManager } from '../data/data-manager';

// API层
import ApiClientFactory from './client';
import { LocalService } from './local-service'; // 仅在LocalClient中使用

// 视图层
import { taskTemplateStorage } from '../utils/storage'; // 兼容层
import { TaskTemplateAPI } from '../api'; // 或直接使用API
```

## 客户端切换

### 本地模式（默认）

```typescript
// src/main.tsx
import { configureApi } from './api/config';

// 不配置baseURL，默认本地模式
configureApi({});
```

### HTTP模式（前后端分离）

```typescript
// src/main.tsx
import { configureApi } from './api/config';

// 配置baseURL切换为HTTP模式
configureApi({ baseURL: 'http://localhost:8080' });
```

**重要：** 切换模式时，只需修改配置，视图层代码无需改动。

## 文件组织

```
src/
├── data/           # 数据层：存储适配器、数据管理器
├── api/            # 接口层：API类、客户端、本地服务
├── components/     # 视图层：React组件
└── utils/          # 工具函数：兼容层、主题等
```

## 参考文档

详细架构说明请参考：
- @docs/ARCHITECTURE.md - 架构总览
- @docs/DATA_LAYER.md - 数据层文档
- @docs/API_LAYER.md - 接口层文档
- @docs/VIEW_LAYER.md - 视图层文档
