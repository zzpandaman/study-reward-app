# 项目架构文档

## 概述

本项目采用三层架构设计，将数据存储、业务逻辑和视图渲染分离，便于维护、扩展和后续转型。

## 架构图

```
┌─────────────────────────────────────────┐
│          视图渲染层 (View Layer)        │
│  - React组件                            │
│  - 用户交互                              │
│  - UI渲染                               │
└─────────────────┬───────────────────────┘
                  │ 调用API
                  ↓
┌─────────────────────────────────────────┐
│         接口能力层 (API Layer)          │
│  - RESTful API抽象                      │
│  - 业务逻辑处理                          │
│  - 数据验证                              │
└─────────────────┬───────────────────────┘
                  │ 调用数据层
                  ↓
┌─────────────────────────────────────────┐
│           数据层 (Data Layer)             │
│  - 数据存储适配器                        │
│  - 版本管理                              │
│  - 数据迁移                              │
└─────────────────────────────────────────┘
```

## 三层架构说明

### 1. 数据层 (Data Layer)

**位置：** `src/data/`

**职责：**
- 数据存储抽象（适配器模式）
- 数据版本管理
- 数据迁移（老用户数据不丢失）
- 数据验证

**核心文件：**
- `storage-adapter.ts`：存储适配器接口和实现
- `data-manager.ts`：数据管理器

**特点：**
- 支持从localStorage平滑迁移到MySQL
- 自动版本检测和迁移
- 数据备份和恢复机制

**详细文档：** [DATA_LAYER.md](./DATA_LAYER.md)

### 2. 接口能力层 (API Layer)

**位置：** `src/api/`

**职责：**
- 业务逻辑抽象
- RESTful API设计
- 数据验证和错误处理
- 便于后续转型Java Web

**核心文件：**
- `types.ts`：API类型定义
- `task-api.ts`：任务相关API
- `product-api.ts`：商品相关API
- `user-api.ts`：用户数据相关API
- `index.ts`：统一导出

**特点：**
- RESTful风格设计
- 统一响应格式
- 类型安全（TypeScript）
- 便于HTTP请求调用

**详细文档：** [API_LAYER.md](./API_LAYER.md)

### 3. 视图渲染层 (View Layer)

**位置：** `src/components/`, `src/App.tsx`

**职责：**
- 用户界面渲染
- 用户交互处理
- 调用API层获取数据
- 用户自定义选项展示

**核心文件：**
- `App.tsx`：主应用组件
- `TaskManager.tsx`：任务管理组件
- `Shop.tsx`：商城组件
- `Inventory.tsx`：背包组件
- `utils/theme.ts`：主题工具

**特点：**
- 丰富的用户自定义选项
- 主题切换
- 数据导入/导出
- 响应式设计

**详细文档：** [VIEW_LAYER.md](./VIEW_LAYER.md)

## 数据流向

### 读取数据流程

```
视图层 → API层 → 数据层 → 存储适配器 → 数据源
         ↓
      返回数据
         ↓
视图层 ← API层 ← 数据层 ← 存储适配器
```

### 写入数据流程

```
视图层 → API层 → 数据层 → 存储适配器 → 数据源
         ↓
      验证数据
         ↓
      保存数据
         ↓
      返回结果
         ↓
视图层 ← API层 ← 数据层 ← 存储适配器
```

## 依赖关系

### 视图层依赖

- ✅ API层（通过import）
- ❌ 不直接依赖数据层

### API层依赖

- ✅ 数据层（通过import）
- ❌ 不依赖视图层

### 数据层依赖

- ✅ TypeScript类型定义
- ❌ 不依赖API层和视图层

## 兼容性保证

### 向后兼容

- **storage.ts兼容层**：保留原有接口，内部使用新架构
- **数据迁移**：自动检测和迁移老用户数据
- **功能保持**：所有现有功能保持不变

### 老用户数据迁移

1. **自动检测**：启动时自动检测旧版本数据
2. **自动迁移**：将旧格式数据转换为新格式
3. **数据保留**：迁移后保留原数据（可选清理）
4. **备份机制**：每次写入前自动备份

## 未来扩展

### 数据层扩展

**MySQL迁移：**
1. 实现`MySQLStorageAdapter`
2. 首次启动时从localStorage迁移
3. 支持双写模式（过渡期）

**数据同步：**
- 多设备数据同步
- 云端备份

### API层扩展

**Java Web转型：**
1. Controller层对应API类
2. Service层处理业务逻辑
3. Repository层访问数据

**HTTP请求：**
- 将本地调用改为HTTP请求
- 添加认证授权
- API限流

### 视图层扩展

**高级自定义：**
- CSS编辑器
- 组件布局自定义
- 快捷键配置

**主题市场：**
- 主题分享
- 主题下载

## 项目结构

```
study-reward-app/
├── src/
│   ├── data/              # 数据层
│   │   ├── storage-adapter.ts
│   │   └── data-manager.ts
│   ├── api/               # 接口层
│   │   ├── types.ts
│   │   ├── task-api.ts
│   │   ├── product-api.ts
│   │   ├── user-api.ts
│   │   └── index.ts
│   ├── components/        # 视图层
│   │   ├── TaskManager.tsx
│   │   ├── Shop.tsx
│   │   └── Inventory.tsx
│   ├── utils/             # 工具函数
│   │   ├── storage.ts     # 兼容层
│   │   └── theme.ts
│   ├── App.tsx
│   └── types.ts
├── docs/                  # 文档
│   ├── ARCHITECTURE.md    # 本文档
│   ├── DATA_LAYER.md
│   ├── API_LAYER.md
│   └── VIEW_LAYER.md
└── ...
```

## 开发指南

### 添加新功能

1. **数据层**：在`data-manager.ts`中添加数据操作
2. **API层**：在对应的API文件中添加接口
3. **视图层**：在组件中调用API并更新UI

### 修改数据结构

1. 更新`types.ts`中的类型定义
2. 在`data-manager.ts`中添加迁移逻辑
3. 更新版本号（schemaVersion）

### 添加新API

1. 在`api/types.ts`中定义请求/响应类型
2. 在对应的API文件中实现接口
3. 在`api/index.ts`中导出

## 测试建议

### 数据层测试

- 数据迁移测试
- 版本兼容性测试
- 数据验证测试

### API层测试

- 接口功能测试
- 错误处理测试
- 数据验证测试

### 视图层测试

- 组件渲染测试
- 用户交互测试
- 主题切换测试

## 总结

三层架构设计实现了关注点分离，提高了代码的可维护性和可扩展性。通过适配器模式和兼容层，保证了老用户数据的平滑迁移。接口层的RESTful设计便于后续转型为Java Web后端。
